<!DOCTYPE html>
<html>
<head>
<link rel="Stylesheet" type="text/css" href="../orz0/orz0.css">
<title>learning-java-from-latke-1 | orz0</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<div id="header">
    <a href="/">Home</a>
</div>
<hr>

<p>
作为PHP程序员是很无聊的, 所以看看Java.我对Java一无所知,以下内容一定有错漏的地方,请路过的高手开示一二.多谢多谢.
这个学习笔记暂时会停留在servlet, latkes上, 暂时不会跨越jetty.
</p>

<p>
从latke-demo的<code>Starter.java</code>开始:
</p>

<pre>
Latkes.setScanPath("org.b3log.latke.demo.hello"); // For Latke IoC
Latkes.initRuntimeEnv();

String classesPath = ClassLoader.getSystemResource("").getPath(); // Real path including maven sub folder

String webappDirLocation = classesPath.replace("target/classes/","src/main/webapp/"); // POM structure in dev env

final File file = new File(webappDirLocation);
if (!file.exists()) {
    webappDirLocation = ""; // production environment
}

final Server server = new Server(Integer.valueOf(Latkes.getServerPort()));
final WebAppContext root = new WebAppContext();
root.setParentLoaderPriority(true); // Use parent class loader
root.setContextPath("/");
root.setDescriptor(webappDirLocation + "/WEB-INF/web.xml");
root.setResourceBase(webappDirLocation);
server.setHandler(root);

try {
    server.start();
} catch (final Exception e) {
    e.printStackTrace();

    System.exit(-1);
}
</pre>

<p>
这段代码前两行Latkes的先略过不表.从这里开始看:
</p>

<div id="ClassLoader.getSystemResource(&quot;&quot;)"><h3 id="ClassLoader.getSystemResource(&quot;&quot;)">ClassLoader.getSystemResource("")</h3></div>

<p>
行为上看: 按照<code>classpath</code>顺序查找参数中指定的资源,包括jar包里面.但是当参数为空串的时候,只会查找目录而不包含jar包. <br>
比如: <code>java -cp WEB-INF/lib/*:WEB-INF/classes Starter</code><br>
</p>

<p>
传递空串会返回<code>/path/to/WEB-INF/classes</code>路径<br>
非空串则会检索jar包,返回类似这种路径 <code>/path/to/WEB-INF/lib/cdi-api-1.0.jar!beans.xsd</code><br>
内部实现没有找到.<br>
</p>

<p>
<code>classPath.replace</code>目的是调试, 因为后和开发时生成的目录结构不一样, 所以算是一个补丁.<br>
上面的代码在产品环境下按照注释:
</p>

<p>
<code>java-cp WEB-INF/lib/*:WEB-INF/classes org.b3log.latke.demo.hello.Starter </code>
</p>

<p>
应该是跑不通的,因为找不到<code>web.xml</code>,只需要<code>java -cp .:WEB-INF/lib/*:WEB-INF/classes</code>, 这样做的原因还是看前面的<code>classloader</code>部分. 
</p>

<p>
代码里面接下来都是关于jetty的, 相关资料看这里: <a href="http:&#47;&#47;www.eclipse.org&#47;jetty&#47;documentation&#47;current&#47;embedding-jetty.html">Embedding jetty</a>,暂时不会深入.
</p>

<div id="Latkes.getServerPort()"><h3 id="Latkes.getServerPort()">Latkes.getServerPort()</h3></div>

<p>
问题: 这个port是怎么来的呢?<br>
Latke类有一个静态初始化块, 里面加载了:
</p>

<ul>
<li>
latke.properties

<li>
local.properties

<li>
remote.properties

</ul>

<p>
三个文件, 第一个是latke框架本身的配置.端口在此配置.那latke是如何加载的呢?回到代码的第二句.
</p>

<div id="Latkes.initRuntimeEnv()"><h3 id="Latkes.initRuntimeEnv()">Latkes.initRuntimeEnv()</h3></div>

<p>
这个函数根据<code>latke.properties</code>初始化了运行环境和数据库配置, 看代码runtimeEnv的值总是Local, 这样的话就会总是去初始化数据库了.不确定为什么.
</p>

<p>
latke到这里算是告一个小小的段落,接下来有一些servlet相关的东西.
</p>

<p>
Starter的代码中, jetty加载了web.xml, 到底jetty如何运作我们先不管,以免战线太长.总之先理解为jetty按照web.xml的说明进行一些初始化工作吧.<br>
但是servlet是绕不过去的,先看web.xml:
</p>

<pre>
&lt;listener&gt;
        &lt;listener-class&gt;org.b3log.latke.demo.hello.HelloServletListener&lt;/listener-class&gt;
&lt;/listener&gt;
</pre>

<p>
这一行定义了<code>servlet</code>的<code>listerner</code>, 什么是<code>listener</code>呢?看这里: <a href="https:&#47;&#47;docs.oracle.com&#47;cd&#47;B14099_19&#47;web.1012&#47;b14017&#47;filters.htm">filters &amp; listeners</a><br>
event listener在servlet发生关键事件时给予应用监听此事件的能力. servlet事件包含两个级别:
</p>

<ul>
<li>
应用级别(怎么形容?就是应用吧)

<li>
会话级别(同一个用户的一系列请求)

</ul>

<p>
<em>但是看latke的代码还有一个请求级别的ServletRequestListener, 暂时还不确定和session级别有多大区别,之后验证</em>
</p>

<p>
现在我们知道jetty在初始化后会通过<code>ServletContextListener</code>通知我们可以接收请求了.接下来latke到底做了哪些事情?下回再说.
</p>

<hr />
<p>
PS: <a href="http:&#47;&#47;www.ibm.com&#47;developerworks&#47;cn&#47;java&#47;j-lo-jetty&#47;index.html">jetty工作原理</a>
</p>

</body>
</html>

